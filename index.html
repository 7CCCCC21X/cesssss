<!doctype html><html lang="zh"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>BSC æ–°æ±  & å¤§é¢åŠ æµç›‘æ§ï¼ˆAPI èšåˆç‰ˆï¼‰</title>
<style>
  body{margin:0;background:#0b0f14;color:#e5e7eb;font-family:system-ui,-apple-system,"PingFang SC",Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  h1{font-size:20px;margin:0 0 10px;color:#60a5fa}
  .panel{display:flex;gap:10px;flex-wrap:wrap;background:#111827;border:1px solid #1f2937;border-radius:10px;padding:12px}
  .panel input{background:#0f172a;border:1px solid #1f2937;color:#e5e7eb;border-radius:8px;padding:8px 10px;outline:none}
  .btn{background:#60a5fa;color:#fff;border:none;border-radius:8px;padding:9px 14px;cursor:pointer}
  .muted{color:#94a3b8;font-size:12px}
  table{width:100%;border-collapse:collapse;margin-top:14px;font-size:13px}
  th,td{border-bottom:1px solid #1f2937;padding:8px;text-align:left;white-space:nowrap}
  th{position:sticky;top:0;background:#0b0f14}
  .usd{color:#22c55e;font-weight:600}
  a{color:#9dd6ff;text-decoration:none}
</style>
</head><body><div class="wrap">
  <h1>BSC æ–°æ±  & å¤§é¢åŠ æµç›‘æ§ï¼ˆåŸºäº Birdeye / GeckoTerminal / DEX Screenerï¼‰</h1>
  <div class="panel">
    <div>
      <div class="muted">å‘Šè­¦é˜ˆå€¼ (USD)</div>
      <input id="th" type="number" value="500000" min="1000" step="5000">
    </div>
    <div>
      <div class="muted">è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰</div>
      <input id="iv" type="number" value="20" min="10" step="5">
    </div>
    <div style="align-self:end">
      <button id="start" class="btn">å¼€å§‹</button>
      <button id="stop" class="btn" disabled>åœæ­¢</button>
      <span id="stat" class="muted">æœªè¿è¡Œ</span>
    </div>
  </div>

  <h3 style="margin:12px 0 6px">ğŸ†• æ–°æ± ï¼ˆæ¥è‡ª GeckoTerminal PROï¼‰</h3>
  <table id="newTbl"><thead>
    <tr><th>æ—¶é—´</th><th>DEX</th><th>Pool</th><th>Base</th><th>Quote</th></tr>
  </thead><tbody></tbody></table>

  <h3 style="margin:18px 0 6px">ğŸ’§ å¤§é¢åŠ æµï¼ˆæ¥è‡ª Birdeye Recent Tradesï¼‰</h3>
  <table id="liqTbl"><thead>
    <tr><th>æ—¶é—´</th><th>ç±»å‹</th><th>Pair</th><th>Î”Base</th><th>Î”Quote</th><th class="usd">ä¼°ç®—USD</th><th>äº¤æ˜“</th></tr>
  </thead><tbody></tbody></table>
</div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const newTB = $('#newTbl tbody');
  const liqTB = $('#liqTbl tbody');
  const stat = $('#stat');
  let timer = null, running = false;
  const seenTx = new Set();
  const watchPairs = new Set(); // è¢«ç›‘æ§çš„ pair

  function fmt(n,d=2){return Number(n).toLocaleString(undefined,{maximumFractionDigits:d});}
  function tstr(ts){return new Date((ts*1000)||Date.now()).toLocaleString();}

  async function fetchJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(r.statusText); return r.json(); }

  async function pullNewPools(){
    try{
      const j = await fetchJSON('/api/gecko-new-pools?network=bsc&page=1');
      (j.items||[]).forEach(x=>{
        if(!x.pool_address) return;
        if(!watchPairs.has(x.pool_address)) watchPairs.add(x.pool_address);
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${x.created_at? new Date(x.created_at).toLocaleString(): ''}</td>
          <td>${x.dex||''}</td>
          <td><a href="https://bscscan.com/address/${x.pool_address}" target="_blank">${x.pool_address}</a></td>
          <td>${x.base||''}</td><td>${x.quote||''}</td>`;
        newTB.prepend(tr);
      });
    }catch(e){ console.warn('new_pools error', e.message); }
  }

  // ä» Birdeye recent å–â€œåŠ æµâ‰¥é˜ˆå€¼â€çš„äº‹ä»¶
  async function pullRecentLiq(thUsd){
    try{
      const j = await fetchJSON(`/api/birdeye-recent?chain=bsc&minUsd=${thUsd}`);
      for(const x of (j.rows||[])){
        if(!x.txHash || seenTx.has(x.txHash)) continue;
        seenTx.add(x.txHash);
        if(x.pair) watchPairs.add(x.pair);

        // å°è¯•ç”¨ DexScreener å†æŸ¥ä¸€æ¬¡ï¼ˆå¯é€‰ï¼‰
        let delta0 = x.amount0 ?? '', delta1 = x.amount1 ?? '';
        let usd = x.volumeUSD ?? 0;

        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${tstr(x.blockTime||0)}</td>
          <td>${x.type||''}</td>
          <td>${x.pair? `<a href="https://bscscan.com/address/${x.pair}" target="_blank">${x.pair}</a>`:'â€”'}</td>
          <td>${delta0!==''? fmt(delta0,6):'â€”'}</td>
          <td>${delta1!==''? fmt(delta1,6):'â€”'}</td>
          <td class="usd">$${fmt(usd)}</td>
          <td>${x.txHash? `<a href="https://bscscan.com/tx/${x.txHash}" target="_blank">æŸ¥çœ‹</a>`:'â€”'}</td>`;
        liqTB.prepend(tr);
      }
    }catch(e){ console.warn('recent error', e.message); }
  }

  function setStatus(s){ stat.textContent = s; }

  function start(){
    if(running) return;
    running = true; $('#start').disabled = true; $('#stop').disabled = false;
    const iv = Math.max(10, Number($('#iv').value)||20)*1000;
    const th = Math.max(1000, Number($('#th').value)||500000);
    setStatus(`è¿è¡Œä¸­ï¼ˆ${iv/1000}s åˆ·æ–°ï¼Œé˜ˆå€¼ $${fmt(th,0)}ï¼‰`);

    // ç«‹å³è·‘ä¸€æ¬¡
    pullNewPools();
    pullRecentLiq(th);
    timer = setInterval(()=>{ pullNewPools(); pullRecentLiq(th); }, iv);
  }

  function stop(){
    if(timer) clearInterval(timer);
    timer=null; running=false;
    $('#start').disabled=false; $('#stop').disabled=true;
    setStatus('å·²åœæ­¢');
  }

  $('#start').addEventListener('click', start);
  $('#stop').addEventListener('click', stop);
})();
</script>
</body></html>
