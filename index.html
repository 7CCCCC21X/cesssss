<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BSC Pancake v2/v3 å¤§é¢åŠ æµç›‘æ§ (â‰¥ $500,000)</title>
<link rel="preconnect" href="https://api.dexscreener.com">
<style>
  :root{--bg:#0b0f14;--card:#121821;--text:#e5e7eb;--muted:#94a3b8;--pri:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--chip:#1f2937}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"PingFang SC",Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:18px auto;padding:0 12px}
  h1{font-size:20px;margin:0 0 12px;color:var(--pri)}
  .panel{display:flex;gap:12px;flex-wrap:wrap;background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:12px}
  .panel .item{display:flex;flex-direction:column;gap:6px;min-width:220px}
  .panel label{font-size:12px;color:var(--muted)}
  .panel input[type="text"], .panel input[type="number"]{
    background:#0f172a;border:1px solid #1f2937;border-radius:8px;color:var(--text);padding:8px 10px;outline:none
  }
  .panel .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .btn{background:var(--pri);color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .chip{background:var(--chip);padding:3px 8px;border-radius:999px;font-size:12px}
  .status{margin-top:10px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:14px;font-size:13px}
  th,td{border-bottom:1px solid #1f2937;padding:8px;text-align:left;white-space:nowrap}
  th{position:sticky;top:0;background:var(--bg)}
  td.code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  .usd{color:var(--ok);font-weight:600}
  a{color:#9dd6ff;text-decoration:none}
  a:hover{text-decoration:underline}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}
  .row .switch{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>BSC Pancake v2/v3 å¤§é¢åŠ æµç›‘æ§ï¼ˆé»˜è®¤é˜ˆå€¼ $500,000ï¼‰</h1>

  <div class="panel">
    <div class="item" style="flex:1 1 340px">
      <label>ğŸ›°ï¸ BSC WebSocket RPCï¼ˆç”¨äºå®æ—¶ç›‘å¬ï¼‰</label>
      <input id="wss" type="text" placeholder="wss://ä½ çš„BSC-WSSï¼ˆå»ºè®® QuickNode/Ankr ä¸“å±ï¼‰">
      <div class="hint">ç¤ºä¾‹ï¼šwss://rpc.ankr.com/bsc/ws ï¼ˆå…¬å…± WSS æ˜“é™æµï¼Œæ¨èä¸“å±ï¼‰</div>
    </div>
    <div class="item" style="flex:1 1 340px">
      <label>ğŸŒ BSC HTTP RPCï¼ˆå¤‡ç”¨ï¼Œç”¨äºè¯»å– token ä¿¡æ¯/ä»·æ ¼è°ƒç”¨ï¼‰</label>
      <input id="http" type="text" placeholder="https://bsc-dataseed1.binance.org">
    </div>
    <div class="item">
      <label>ğŸ’° å‘Šè­¦é˜ˆå€¼ï¼ˆUSDï¼‰</label>
      <input id="th" type="number" value="500000" min="1000" step="5000">
    </div>
    <div class="item">
      <label>â±ï¸ ä»·æ ¼ç¼“å­˜ï¼ˆç§’ï¼‰</label>
      <input id="ttl" type="number" value="60" min="10" step="10">
    </div>

    <div class="item" style="min-width:260px">
      <label>ğŸ“£ Telegramï¼ˆå¯é€‰ï¼Œå‰ç«¯ç›´å‘ <span class="chip">ä¸å®‰å…¨</span>ï¼‰</label>
      <input id="tgToken" type="text" placeholder="BOT_TOKENï¼ˆä¸å»ºè®®åœ¨å…¬å…±ç«™ç‚¹å¡«å†™ï¼‰">
      <input id="tgChat" type="text" placeholder="CHAT_ID">
      <div class="hint">æ›´å®‰å…¨åšæ³•ï¼šä½¿ç”¨ Vercel çš„ /api/notifyï¼ˆè§ä¸‹æ–‡ B æ–¹æ¡ˆï¼‰ã€‚</div>
    </div>

    <div class="item" style="min-width:220px">
      <label>ğŸ”§ ç›‘å¬æ¨¡å—</label>
      <div class="row">
        <label class="switch"><input id="swV2" type="checkbox" checked> Pancake v2ï¼ˆPair.Mintï¼‰</label>
      </div>
      <div class="row">
        <label class="switch"><input id="swV3Pool" type="checkbox" checked> Pancake v3ï¼ˆPool.Mintï¼‰</label>
      </div>
      <div class="row">
        <label class="switch"><input id="swV3NPM" type="checkbox" checked> v3 PositionManagerï¼ˆIncreaseLiquidityï¼‰</label>
      </div>
    </div>

    <div class="item" style="align-self:flex-end">
      <div class="row">
        <button id="start" class="btn">å¼€å§‹ç›‘å¬</button>
        <button id="stop" class="btn" disabled>åœæ­¢</button>
        <span id="stat" class="status">æœªè¿æ¥</span>
      </div>
    </div>
  </div>

  <div class="hint">ä»…ç»Ÿè®¡ã€Œå•ç¬”æ–°å¢â‰¥é˜ˆå€¼ã€çš„åŠ æµäº‹ä»¶ã€‚ä»·æ ¼æºï¼šDexScreenerï¼ˆé€‰ BSC & æµåŠ¨æ€§æœ€é«˜çš„æ± ï¼‰ã€‚ç¨³å®šå¸ USDT/USDC/BUSD ç›´æ¥æŒ‰ $1ã€‚</div>

  <table id="tbl">
    <thead>
      <tr>
        <th>æ—¶é—´</th><th>ç±»å‹</th><th>Pool/Pair</th><th>Token0</th><th>Î”0</th><th>Price0</th>
        <th>Token1</th><th>Î”1</th><th>Price1</th><th class="usd">ä¼°ç®—USD</th><th>äº¤æ˜“</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- ethers v5 UMDï¼ˆæµè§ˆå™¨ç«¯ä½¿ç”¨ï¼‰ -->
<script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
<script>
(async function(){
  const V2_FACTORY = '0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73'.toLowerCase();
  const V3_FACTORY = '0x0BFbCF9fa4f9C56B0F40a671Ad40E0805A091865'.toLowerCase();
  const V3_NPM     = '0x46a15b0b27311cedf172ab29e4f4766fbe7f4364'.toLowerCase();

  const STABLES = new Set([
    '0x55d398326f99059ff775485246999027b3197955', // USDT
    '0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d', // USDC
    '0xe9e7cea3dedca5984780bafc599bd69add087d56'  // BUSD (å†å²)
  ].map(s => s.toLowerCase()));

  const ifaceV2Mint = new ethers.utils.Interface([
    'event Mint(address indexed sender, uint amount0, uint amount1)',
    'function token0() view returns (address)',
    'function token1() view returns (address)',
    'function factory() view returns (address)'
  ]);
  const ifaceV3Pool = new ethers.utils.Interface([
    'event Mint(address sender,address owner,int24 tickLower,int24 tickUpper,uint128 amount,uint256 amount0,uint256 amount1)',
    'function token0() view returns (address)',
    'function token1() view returns (address)',
    'function factory() view returns (address)'
  ]);
  const ifaceNPM = new ethers.utils.Interface([
    'event IncreaseLiquidity(uint256 indexed tokenId,uint128 liquidity,uint256 amount0,uint256 amount1)',
    'function positions(uint256 tokenId) view returns (uint96,address,address,address,uint24,int24,int24,uint128,uint256,uint256,uint128,uint128)'
  ]);
  const ifaceV3Factory = new ethers.utils.Interface([
    'function getPool(address token0,address token1,uint24 fee) view returns (address)'
  ]);
  const ifaceERC20 = new ethers.utils.Interface([
    'function decimals() view returns (uint8)',
    'function symbol() view returns (string)'
  ]);
  const ifaceERC20Bytes = new ethers.utils.Interface([
    'function symbol() view returns (bytes32)'
  ]);

  // UI refs
  const $ = sel => document.querySelector(sel);
  const tb = $('#tbl tbody');
  const stat = $('#stat');
  const btnStart = $('#start'), btnStop = $('#stop');

  // çŠ¶æ€
  let providerWss = null;
  let providerHttp = null;
  let running = false;
  const seen = new Set();
  const decCache = new Map();
  const symCache = new Map();
  const priceCache = new Map();

  function nowStr(){ const d=new Date(); return d.toLocaleString(); }
  function fmt(n, d=2){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }

  async function decimalsOf(addr){
    const k = addr.toLowerCase();
    if(decCache.has(k)) return decCache.get(k);
    try{
      const c = new ethers.Contract(addr, ifaceERC20, providerHttp);
      const d = await c.decimals();
      decCache.set(k, d);
      return d;
    }catch(e){ decCache.set(k, 18); return 18; }
  }
  async function symbolOf(addr){
    const k = addr.toLowerCase();
    if(symCache.has(k)) return symCache.get(k);
    try{
      const c = new ethers.Contract(addr, ifaceERC20, providerHttp);
      const s = await c.symbol();
      symCache.set(k, s);
      return s;
    }catch(e){
      try{
        const c2 = new ethers.Contract(addr, ifaceERC20Bytes, providerHttp);
        const b = await c2.symbol();
        const s = ethers.utils.parseBytes32String(b);
        symCache.set(k, s);
        return s;
      }catch{ const short = k.slice(0,6); symCache.set(k, short); return short; }
    }
  }
  async function priceUsd(addr, ttlMs){
    const k = addr.toLowerCase();
    if(STABLES.has(k)) return 1;
    const hit = priceCache.get(k);
    const now = Date.now();
    if(hit && now - hit.ts < ttlMs) return hit.price;

    try{
      const r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${k}`);
      const j = await r.json();
      const pairs = Array.isArray(j && j.pairs) ? j.pairs : [];
      const best = pairs
        .filter(p => p && p.chainId==='bsc' && p.priceUsd && !isNaN(+p.priceUsd))
        .sort((a,b) => (b?.liquidity?.usd||0) - (a?.liquidity?.usd||0))[0];
      const price = best ? Number(best.priceUsd) : NaN;
      if(isFinite(price)) { priceCache.set(k,{price,ts:now}); return price; }
      return NaN;
    }catch{ return NaN; }
  }

  async function amountsToUsd(token0, token1, a0Raw, a1Raw, ttlMs){
    const [d0,d1] = await Promise.all([decimalsOf(token0), decimalsOf(token1)]);
    const a0 = Number(ethers.utils.formatUnits(a0Raw, d0));
    const a1 = Number(ethers.utils.formatUnits(a1Raw, d1));
    const [p0,p1] = await Promise.all([priceUsd(token0, ttlMs), priceUsd(token1, ttlMs)]);
    return { a0, a1, p0, p1, usd: (isFinite(p0)?a0*p0:0) + (isFinite(p1)?a1*p1:0) };
  }

  function addRow({type, pool, token0, token1, sym0, sym1, a0, a1, p0, p1, usd, tx}){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${nowStr()}</td>
      <td>${type}</td>
      <td class="code"><a href="https://bscscan.com/address/${pool}" target="_blank">${pool}</a></td>
      <td>${sym0}</td>
      <td>${fmt(a0,6)}</td>
      <td>$${isFinite(p0)?fmt(p0):'--'}</td>
      <td>${sym1}</td>
      <td>${fmt(a1,6)}</td>
      <td>$${isFinite(p1)?fmt(p1):'--'}</td>
      <td class="usd">$${fmt(usd)}</td>
      <td><a href="https://bscscan.com/tx/${tx}" target="_blank">æŸ¥çœ‹</a></td>
    `;
    tb.prepend(tr);
  }

  async function notifyTG(text){
    const token = $('#tgToken').value.trim();
    const chat  = $('#tgChat').value.trim();
    if(!token || !chat) return;
    try{
      await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ chat_id: chat, text, parse_mode:'HTML', disable_web_page_preview:true })
      });
    }catch(e){ console.warn('TG å‘é€å¤±è´¥', e); }
  }

  function setStatus(s){ stat.textContent = s; }

  async function start(){
    if(running) return;
    const wss = $('#wss').value.trim();
    const http = $('#http').value.trim() || 'https://bsc-dataseed1.binance.org';
    const ttlSec = Math.max(10, Number($('#ttl').value)||60);
    const TH = Math.max(1000, Number($('#th').value)||500000);

    if(!wss){ alert('è¯·å¡«å†™ BSC WebSocket RPC'); return; }

    // å»ºç«‹ Provider
    try{
      providerWss = new ethers.providers.WebSocketProvider(wss);
      providerHttp = new ethers.providers.JsonRpcProvider(http);
    }catch(e){
      alert('RPC é…ç½®é”™è¯¯ï¼š' + e.message);
      return;
    }

    running = true;
    btnStart.disabled = true; btnStop.disabled = false;
    setStatus('è¿æ¥ä¸­â€¦');

    providerWss._websocket.onopen = ()=> setStatus('å·²è¿æ¥ï¼ˆå®æ—¶ç›‘å¬ä¸­ï¼‰');
    providerWss._websocket.onclose = ()=> { setStatus('è¿æ¥æ–­å¼€'); stop(); };

    // è®¢é˜… V2 Pair.Mintï¼ˆå…¨ç½‘ï¼Œåç»­æŒ‰ factory è¿‡æ»¤ï¼‰
    if($('#swV2').checked){
      const topic = ethers.utils.id('Mint(address,uint256,uint256)');
      providerWss.on({ topics:[topic] }, async (log)=>{
        if(!running) return;
        const key = `${log.transactionHash}:${log.index}`;
        if(seen.has(key)) return; seen.add(key);

        const pairAddr = log.address;
        const pair = new ethers.Contract(pairAddr, ifaceV2Mint, providerHttp);
        let fac; try{ fac = (await pair.factory()).toLowerCase(); }catch{ return; }
        if(fac !== V2_FACTORY) return;

        let parsed; try{ parsed = ifaceV2Mint.parseLog(log); }catch{ return; }
        const [ , amount0, amount1 ] = parsed.args;
        const [t0, t1] = await Promise.all([pair.token0(), pair.token1()]);
        const { a0, a1, p0, p1, usd } = await amountsToUsd(t0, t1, amount0, amount1, ttlSec*1000);
        if(!isFinite(usd) || usd < TH) return;

        const [s0,s1] = await Promise.all([symbolOf(t0), symbolOf(t1)]);
        addRow({ type:'V2 Mint', pool:pairAddr, token0:t0, token1:t1, sym0:s0, sym1:s1, a0,a1,p0,p1,usd, tx:log.transactionHash });
        notifyTG(`ğŸŸ¢ <b>Pancake V2 å¤§é¢åŠ æµ</b>\nPair: <code>${pairAddr}</code>\nTx: https://bscscan.com/tx/${log.transactionHash}\n${s0}: +${fmt(a0,6)} (~$${fmt(p0)})\n${s1}: +${fmt(a1,6)} (~$${fmt(p1)})\nä¼°ç®—æ–°å¢ï¼š<b>$${fmt(usd)}</b>ï¼ˆé˜ˆå€¼ $${fmt(TH,0)}ï¼‰`);
      });
    }

    // è®¢é˜… V3 Pool.Mint
    if($('#swV3Pool').checked){
      const topic = ethers.utils.id('Mint(address,address,int24,int24,uint128,uint256,uint256)');
      providerWss.on({ topics:[topic] }, async (log)=>{
        if(!running) return;
        const key = `${log.transactionHash}:${log.index}`;
        if(seen.has(key)) return; seen.add(key);

        const poolAddr = log.address;
        const pool = new ethers.Contract(poolAddr, ifaceV3Pool, providerHttp);
        let fac; try{ fac = (await pool.factory()).toLowerCase(); }catch{ return; }
        if(fac !== V3_FACTORY) return;

        let parsed; try{ parsed = ifaceV3Pool.parseLog(log); }catch{ return; }
        const amount0 = parsed.args.amount0, amount1 = parsed.args.amount1;
        const [t0, t1] = await Promise.all([pool.token0(), pool.token1()]);
        const { a0, a1, p0, p1, usd } = await amountsToUsd(t0, t1, amount0, amount1, ttlSec*1000);
        if(!isFinite(usd) || usd < TH) return;

        const [s0,s1] = await Promise.all([symbolOf(t0), symbolOf(t1)]);
        addRow({ type:'V3 Pool.Mint', pool:poolAddr, token0:t0, token1:t1, sym0:s0, sym1:s1, a0,a1,p0,p1,usd, tx:log.transactionHash });
        notifyTG(`ğŸŸ¢ <b>Pancake V3 å¤§é¢åŠ æµï¼ˆPool.Mintï¼‰</b>\nPool: <code>${poolAddr}</code>\nTx: https://bscscan.com/tx/${log.transactionHash}\n${s0}: +${fmt(a0,6)} (~$${fmt(p0)})\n${s1}: +${fmt(a1,6)} (~$${fmt(p1)})\nä¼°ç®—æ–°å¢ï¼š<b>$${fmt(usd)}</b>ï¼ˆé˜ˆå€¼ $${fmt(TH,0)}ï¼‰`);
      });
    }

    // è®¢é˜… v3 PositionManager.IncreaseLiquidityï¼ˆå®˜æ–¹åœ°å€å•ç‚¹ï¼‰
    if($('#swV3NPM').checked){
      const topic = ethers.utils.id('IncreaseLiquidity(uint256,uint128,uint256,uint256)');
      providerWss.on({ address: V3_NPM, topics:[topic] }, async (log)=>{
        if(!running) return;
        const key = `${log.transactionHash}:${log.index}`;
        if(seen.has(key)) return; seen.add(key);

        let parsed; try{ parsed = ifaceNPM.parseLog(log); }catch{ return; }
        const tokenId = parsed.args.tokenId;
        const amount0 = parsed.args.amount0, amount1 = parsed.args.amount1;

        const npm = new ethers.Contract(V3_NPM, ifaceNPM, providerHttp);
        let pos; try{ pos = await npm.positions(tokenId); }catch{ return; }
        const t0 = pos[2], t1 = pos[3], fee = pos[4];

        const { a0, a1, p0, p1, usd } = await amountsToUsd(t0, t1, amount0, amount1, ttlSec*1000);
        if(!isFinite(usd) || usd < TH) return;

        const [s0,s1] = await Promise.all([symbolOf(t0), symbolOf(t1)]);
        // åæŸ¥ pool åœ°å€ï¼ˆå¯é€‰ï¼Œä¸æŸ¥ä¹Ÿèƒ½çœ‹ txï¼‰
        let poolAddr = 'â€”';
        try{
          const v3f = new ethers.Contract(V3_FACTORY, ifaceV3Factory, providerHttp);
          poolAddr = await v3f.getPool(t0, t1, fee);
        }catch{}
        addRow({ type:'V3 NPM.IncreaseLiquidity', pool:poolAddr, token0:t0, token1:t1, sym0:s0, sym1:s1, a0,a1,p0,p1,usd, tx:log.transactionHash });
        notifyTG(`ğŸŸ¢ <b>Pancake V3 å¤§é¢åŠ æµï¼ˆPositionManagerï¼‰</b>\nPool: <code>${poolAddr}</code>\nTx: https://bscscan.com/tx/${log.transactionHash}\n${s0}: +${fmt(a0,6)} (~$${fmt(p0)})\n${s1}: +${fmt(a1,6)} (~$${fmt(p1)})\nä¼°ç®—æ–°å¢ï¼š<b>$${fmt(usd)}</b>ï¼ˆé˜ˆå€¼ $${fmt(TH,0)}ï¼‰`);
      });
    }
  }

  function stop(){
    if(providerWss){
      try{ providerWss.removeAllListeners(); }catch{}
      try{ providerWss._websocket && providerWss._websocket.close(); }catch{}
    }
    providerWss = null; running = false;
    btnStart.disabled = false; btnStop.disabled = true;
    setStatus('å·²åœæ­¢');
  }

  $('#start').addEventListener('click', start);
  $('#stop').addEventListener('click', stop);
})();
</script>
</body>
</html>
